#!/usr/bin/env ruby

require 'todo'

opts = {color:true}
if ARGV[0] == '-C'
  opts[:color] = false 
  ARGV.shift
end

t = Todo.new opts

args = ARGV.dup

# Autoexpand any tags

command = args.shift
has_args = !args.empty?

/^(?<context>@\S+)$/ =~ command
/^(?<project>\+\S+)$/ =~ command

# TODO allow filtering done by context

if context && has_args
  t.ed_command!('a', [Todo.expand_tag(context)] + args)
elsif context 
  t.filter Todo.expand_tag(context)
elsif project && has_args
  t.ed_command!('a', [Todo.expand_tag(project)] + args)
elsif project 
  t.filter Todo.expand_tag(project)
elsif command =~ /^pri/ && args.empty?
  t.filter '!'
elsif command == 'done' && args[0] =~ /^(@|\+)/
  t.filter_done_file  Todo.expand_tag(args[0])
elsif command == 'done'
  t.filter_done_file nil
elsif command == 'all' 
  t.list_all Todo.expand_tag(args[0])
elsif command == 'do' 
  t.mark_done! args[0]
elsif command == 'undo' 
  t.mark_undone! args[0]
elsif command == 'ls' && args.empty?
  t.report
elsif command == 'revert' && args.empty?
  t.revert
elsif command.nil?
  t.catn 
else
  t.ed_command! command, *args
end

