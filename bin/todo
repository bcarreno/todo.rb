#!/usr/bin/env ruby

require 'todo'

t = Todo.new

args = ARGV.dup

# Autoexpand any tags

args = args.map {|a| 
  if a =~ /^(@@|\+\+)/ && (expanded_tag = Todo.expand_tag(a[1..-1]))
    expanded_tag
  else
    a
  end
}

command = args.shift

/^(?<context>@\S+)$/ =~ command
/^(?<project>\+\S+)$/ =~ command

# TODO allow filtering done by context

if context && args.empty?
  t.filter Todo.expand_tag(context)
elsif context && !args.empty?
  t.ed_command!('a', [Todo.expand_tag(context)] + args)
elsif project && args.empty?
  t.filter Todo.expand_tag(project)
elsif project && !args.empty?
  t.ed_command!('a', [Todo.expand_tag(project)] + args)
elsif command =~ /^pri/ && args.empty?
  t.filter '!'
elsif command == 'done' && args[0] =~ /^(@|\+)/
  t.filter_done_file  Todo.expand_tag(args[0])
elsif command == 'done' && args.empty?
  t.filter
elsif command == 'all' 
  t.list_all Todo.expand_tag(args[0])
elsif command == 'do' 
  t.mark_done! args[0]
elsif command == 'undo' 
  t.mark_undone! args[0]
elsif command == 'ls' && args.empty?
  t.report
elsif command == 'revert' && args.empty?
  t.revert
elsif command.nil?
  t.catn 
else
  t.ed_command! command, *args
end

